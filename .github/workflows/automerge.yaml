name: Auto-merge

on:
  # Only trigger when checks complete (after CI passes)
  check_suite:
    types: [completed]
  # Or when automerge label is added
  pull_request:
    types: [labeled]

jobs:
  automerge:
    name: Auto-merge PRs
    runs-on: ubuntu-latest
    # Only run for PRs (not main branch pushes)
    if: |
      github.event.pull_request != null || 
      (github.event.check_suite != null && github.event.check_suite.pull_requests[0] != null)
    permissions:
      contents: write
      pull-requests: write
    outputs:
      merged: ${{ steps.automerge.outputs.mergeResult }}
    steps:
      - id: automerge
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: "automerge,!wip,!do-not-merge"
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "pull-request-title"
          MERGE_FORKS: "false"
          MERGE_RETRIES: "6"
          MERGE_RETRY_SLEEP: "10000"
          UPDATE_LABELS: ""
          UPDATE_METHOD: "rebase"

  trigger-cicd:
    name: Trigger CI/CD after merge
    runs-on: ubuntu-latest
    needs: automerge
    # Only trigger if merge was successful
    if: needs.automerge.outputs.merged == 'merged'
    permissions:
      actions: write
    steps:
      - name: Trigger CI/CD workflow
        run: |
          gh workflow run ci-cd.yaml --ref main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
